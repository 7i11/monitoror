#!/usr/bin/env bash

##########################################################################
# This script is used by CircleCi to deploy release version of monitoror #
##########################################################################

VERSION=$(git describe --tags --exact-match HEAD 2>/dev/null || true)
CHANGELOG=$(cat CHANGELOG 2>/dev/null)

if [[ ${VERSION} == "" ]]; then
  echo "No tag found. Skip"
  exit 0
fi

go get github.com/tcnksm/ghr

echo "Starting release-on-github script ..."
echo " - VERSION: ${VERSION}"

ghr \
  -t ${GITHUB_TOKEN} \
  -u ${CIRCLE_PROJECT_USERNAME} \
  -r ${CIRCLE_PROJECT_REPONAME} \
  -c ${CIRCLE_SHA1} \
  -delete \
  -n "Release ${VERSION}" \
  -b "${CHANGELOG}" \
  ${VERSION} \
  ./output/
